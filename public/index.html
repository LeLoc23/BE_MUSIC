<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music App Pro</title>
    <style>
        /* CSS CH√çNH */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        .sidebar { width: 280px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .main-content { flex: 1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Auth & Inputs */
        .auth-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .auth-tab { flex: 1; padding: 8px; text-align: center; background: #eee; cursor: pointer; border-radius: 5px; font-size: 13px; }
        .auth-tab.active { background: #007bff; color: white; font-weight: bold; }
        
        input, textarea { padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; width: 100%; color: white; background: #007bff; }
        button:hover { background: #0056b3; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #e9ecef; color: #495057; flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; }
        .tab-btn.active { background: #007bff; color: white; }

        /* Search */
        .search-container { display: flex; gap: 10px; margin-bottom: 15px; display: none; }
        .search-container input { margin-bottom: 0; }
        .search-container button { width: auto; padding: 0 20px; background: #17a2b8; }

        /* List */
        .song-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .song-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f1f1; border-radius: 8px; cursor: pointer; }
        .song-item:hover { background: #f8f9fa; }
        .song-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 15px; background: #ddd; }
        .playlist-icon { width: 50px; height: 50px; border-radius: 8px; background: #ffc107; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; color: white; }
        
        /* Buttons */
        .action-btn { width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; border-radius: 4px; border:none; color:white; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-cyan { background: #17a2b8; }
        .btn-orange { background: #fd7e14; }
        .btn-purple { background: #6f42c1; }
        .btn-heart { background: transparent; color: #ccc; font-size: 20px; padding: 0 5px; border: 1px solid #eee; }
        .btn-heart.liked { color: #e91e63; border-color: #e91e63; }

        /* Player & Lyrics */
        .player-bar { margin-top: 20px; padding: 15px; background: #212529; color: white; border-radius: 12px; text-align: center; display: none; }
        audio { width: 100%; margin-top: 10px; }
        .btn-lyrics { background: transparent; border: 1px solid #fff; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; }
        .btn-lyrics:hover { background: rgba(255,255,255,0.2); }
        .lyrics-text { white-space: pre-wrap; line-height: 1.6; font-size: 14px; color: #333; max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #eee; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .modal-header { font-weight: bold; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .modal-item { padding: 10px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .modal-item:hover { background: #f0f8ff; color: #007bff; }
        .close-btn { background: #6c757d; margin-top: 15px; }
        
        .video-box { width: 800px; background: #000; position: relative; }
        .video-player { width: 100%; height: 450px; }
        .close-video-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.3); color: white; width: 30px; height: 30px; border-radius: 50%; font-size: 20px; line-height: 30px; padding: 0; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div id="authSection">
            <h3 style="text-align:center; margin-top:0;">üîê T√†i kho·∫£n</h3>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showAuth('login')" id="tabLogin">ƒêƒÉng Nh·∫≠p</div>
                <div class="auth-tab" onclick="showAuth('register')" id="tabReg">ƒêƒÉng K√Ω</div>
            </div>
            <div id="loginForm">
                <input type="text" id="loginUser" placeholder="User (VD: admin)">
                <input type="password" id="loginPass" placeholder="Pass">
                <button onclick="doLogin()">ƒêƒÉng Nh·∫≠p</button>
            </div>
            <div id="regForm" style="display:none;">
                <input type="text" id="regUser" placeholder="User m·ªõi">
                <input type="password" id="regPass" placeholder="Pass m·ªõi">
                <button onclick="doRegister()" class="btn-green">ƒêƒÉng K√Ω</button>
            </div>
            <p id="authMsg" style="color:red; text-align:center; font-size:13px;"></p>
        </div>

        <div id="userSection" style="display:none;">
            <h3 style="margin-top:0;">üëã Hi, <span id="displayUser"></span></h3>
            <p style="font-size:13px; color:#666;">Role: <span id="displayRole" style="font-weight:bold;"></span></p>
            
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <h4>üìÅ Playlist</h4>
                <input type="text" id="newPlName" placeholder="T√™n Playlist...">
                <button onclick="createPlaylist()" style="background:#6c757d;">T·∫°o M·ªõi</button>
            </div>

            <div id="adminPanel" style="display:none; margin-top:20px; background:#fff3cd; padding:10px; border-radius:8px;">
                <h4 style="margin:0 0 10px 0;">üõ† Nh·∫≠p Li·ªáu Nh·∫°c</h4>
                <input type="text" id="newTitle" placeholder="T√™n b√†i*">
                <input type="text" id="newArtist" placeholder="Ca sƒ©*">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newGenre" placeholder="Th·ªÉ lo·∫°i">
                    <input type="number" id="newYear" placeholder="NƒÉm">
                </div>
                <textarea id="newLyrics" placeholder="L·ªùi b√†i h√°t..." rows="2"></textarea>
                <label style="font-size:11px;">File Nh·∫°c (.mp3)*:</label> <input type="file" id="newFile" accept="audio/*">
                <label style="font-size:11px;">·∫¢nh B√¨a (.jpg):</label> <input type="file" id="newImage" accept="image/*">
                <label style="font-size:11px;">Video (.mp4):</label> <input type="file" id="newVideo" accept="video/*">
                <button onclick="addSong()">‚òÅÔ∏è Upload & Th√™m</button>
            </div>
            <button onclick="doLogout()" class="btn-red" style="margin-top:20px;">ƒêƒÉng Xu·∫•t</button>
        </div>
    </div>

    <div class="main-content">
        <div class="tabs">
            <button class="tab-btn active" id="btnAll" onclick="switchTab('all')">üéµ Kho Nh·∫°c</button>
            <button class="tab-btn" id="btnLikes" onclick="switchTab('likes')">‚ù§Ô∏è Y√™u Th√≠ch</button>
            <button class="tab-btn" id="btnPl" onclick="switchTab('playlists')">üìÇ Playlist</button>
            <button class="tab-btn" id="btnHistory" onclick="switchTab('history')">üïí L·ªãch S·ª≠</button>
            <button class="tab-btn" id="btnUsers" style="display:none;" onclick="switchTab('users')">üë• QL User</button>
        </div>

        <div id="searchBox" class="search-container">
            <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm..." onkeypress="handleEnter(event)">
            <button onclick="searchSong()">T√¨m</button>
        </div>

        <ul class="song-list" id="playlist">
            <li style="text-align:center; padding:20px;">Vui l√≤ng ƒëƒÉng nh·∫≠p...</li>
        </ul>

        <div class="player-bar" id="playerBar">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div id="nowPlayingText" style="font-weight:bold;">S·∫µn s√†ng</div>
                <button class="btn-lyrics" onclick="showLyricsModal()">üìñ L·ªùi b√†i h√°t</button>
            </div>
            <audio id="audioPlayer" controls></audio>
        </div>
    </div>

    <div class="modal-overlay" id="playlistModal">
        <div class="modal-box">
            <div class="modal-header">Ch·ªçn Playlist</div>
            <ul class="modal-list" id="modalPlaylistList"><li>ƒêang t·∫£i...</li></ul>
            <button class="close-btn" onclick="closeModal('playlistModal')">ƒê√≥ng</button>
        </div>
    </div>

    <div class="modal-overlay" id="videoModal">
        <div class="modal-box video-box">
            <button class="close-video-btn" onclick="closeVideo()">√ó</button>
            <video id="videoPlayer" class="video-player" controls></video>
        </div>
    </div>

    <div class="modal-overlay" id="lyricsModal">
        <div class="modal-box">
            <div class="modal-header">üìñ L·ªùi b√†i h√°t</div>
            <div id="lyricsContent" class="lyrics-text">...</div>
            <button class="close-btn" onclick="closeModal('lyricsModal')">ƒê√≥ng</button>
        </div>
    </div>

    <div class="modal-overlay" id="editSongModal">
        <div class="modal-box">
            <div class="modal-header">‚úèÔ∏è S·ª≠a th√¥ng tin</div>
            <input type="hidden" id="editId">
            <label style="font-size:12px;">T√™n b√†i:</label><input type="text" id="editTitle">
            <label style="font-size:12px;">Ca sƒ©:</label><input type="text" id="editArtist">
            <div style="display:flex; gap:10px;">
                <input type="text" id="editGenre" placeholder="Th·ªÉ lo·∫°i">
                <input type="number" id="editYear" placeholder="NƒÉm">
            </div>
            <label style="font-size:12px;">L·ªùi b√†i h√°t:</label><textarea id="editLyrics" rows="4"></textarea>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="submitEditSong()" class="btn-green">L∆∞u</button>
                <button onclick="closeModal('editSongModal')" class="close-btn" style="margin-top:0;">H·ªßy</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000/api";
        let currentUser = null;
        let selectedSongId = null;
        let likedSongIds = [];
        let currentLyricsContent = "";

        // --- AUTH ---
        function showAuth(t) {
            document.getElementById('loginForm').style.display = t=='login'?'block':'none';
            document.getElementById('regForm').style.display = t=='register'?'block':'none';
            document.getElementById('tabLogin').className = t=='login'?'auth-tab active':'auth-tab';
            document.getElementById('tabReg').className = t=='register'?'auth-tab active':'auth-tab';
        }
        async function doLogin() {
            const u=document.getElementById('loginUser').value, p=document.getElementById('loginPass').value;
            if(!u||!p) return;
            try {
                const res = await fetch(`${API_URL}/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
                const json = await res.json();
                if(res.ok) {
                    currentUser = json.user;
                    updateUI(true);
                    switchTab('all');
                } else document.getElementById('authMsg').innerText = json.error;
            } catch(e){ alert("L·ªói k·∫øt n·ªëi"); }
        }
        async function doRegister() {
            const u=document.getElementById('regUser').value, p=document.getElementById('regPass').value;
            if(!u||!p) return;
            try {
                const res = await fetch(`${API_URL}/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
                const json = await res.json();
                if(res.ok) { alert("Th√†nh c√¥ng!"); showAuth('login'); }
                else document.getElementById('authMsg').innerText = json.error;
            } catch(e){ alert("L·ªói k·∫øt n·ªëi"); }
        }
        function doLogout() { currentUser=null; likedSongIds=[]; updateUI(false); location.reload(); }
        function updateUI(isLogin) {
            document.getElementById('authSection').style.display = isLogin?'none':'block';
            document.getElementById('userSection').style.display = isLogin?'block':'none';
            if(isLogin) {
                document.getElementById('displayUser').innerText = currentUser.username;
                document.getElementById('displayRole').innerText = currentUser.role;
                const isAdmin = currentUser.role==='admin';
                document.getElementById('adminPanel').style.display = isAdmin?'block':'none';
                document.getElementById('btnUsers').style.display = isAdmin?'block':'none';
            }
        }

        // --- TABS ---
        function switchTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const searchBox = document.getElementById('searchBox');
            searchBox.style.display = 'none';
            if(type=='all') { document.getElementById('btnAll').classList.add('active'); searchBox.style.display = 'flex'; loadSongs(); }
            else if(type=='likes') { document.getElementById('btnLikes').classList.add('active'); loadLikedSongs(); }
            else if(type=='playlists') { document.getElementById('btnPl').classList.add('active'); loadPlaylists(); }
            else if(type=='history') { document.getElementById('btnHistory').classList.add('active'); loadHistory(); }
            else if(type=='users') { document.getElementById('btnUsers').classList.add('active'); loadUsers(); }
        }
        function searchSong() { loadSongs(document.getElementById('searchInput').value); }
        function handleEnter(e) { if(e.key==='Enter') searchSong(); }

        // --- SONGS & ACTIONS ---
        async function fetchLikedIds() {
            if(!currentUser) return;
            const res = await fetch(`${API_URL}/user/likes/ids`, { headers: {'X-User-ID': currentUser.id} });
            likedSongIds = await res.json();
        }
        async function toggleLike(e, songId) {
            e.stopPropagation();
            if(!currentUser) return alert("C·∫ßn ƒëƒÉng nh·∫≠p!");
            const btn = e.target;
            const res = await fetch(`${API_URL}/user/likes/toggle`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-User-ID': currentUser.id }, body: JSON.stringify({ song_id: songId }) });
            const json = await res.json();
            if(json.status) { btn.classList.add('liked'); btn.innerText = '‚ù§Ô∏è'; likedSongIds.push(songId); } 
            else { btn.classList.remove('liked'); btn.innerText = 'ü§ç'; likedSongIds = likedSongIds.filter(id => id !== songId); if(document.getElementById('btnLikes').classList.contains('active')) loadLikedSongs(); }
        }

        async function loadSongs(query="") {
            await fetchLikedIds(); 
            const list = document.getElementById('playlist');
            list.innerHTML = "<li>ƒêang t·∫£i...</li>";
            let url = `${API_URL}/songs`;
            if(query) url += `?q=${encodeURIComponent(query)}`;
            const res = await fetch(url);
            const json = await res.json();
            list.innerHTML = "";
            if (json.data.length === 0) return list.innerHTML = `<li style="text-align:center; padding:20px;">Kh√¥ng t√¨m th·∫•y.</li>`;
            json.data.forEach(song => renderSongItem(song, list));
        }
        async function loadLikedSongs() {
            if(!currentUser) return alert("C·∫ßn ƒëƒÉng nh·∫≠p!");
            const list = document.getElementById('playlist');
            list.innerHTML = "<li>ƒêang t·∫£i...</li>";
            await fetchLikedIds(); 
            const res = await fetch(`${API_URL}/user/likes`, { headers: { 'X-User-ID': currentUser.id } });
            const json = await res.json();
            list.innerHTML = "";
            if (json.data.length === 0) return list.innerHTML = `<li style="text-align:center; padding:20px;">Ch∆∞a th√≠ch b√†i n√†o.</li>`;
            json.data.forEach(song => renderSongItem(song, list));
        }

        function renderSongItem(song, listElement) {
            const li = document.createElement('li'); li.className='song-item';
            // Truy·ªÅn to√†n b·ªô object song v√†o playSong
            li.onclick = (e) => { if(e.target.tagName!=='BUTTON') playSong(song); };
            
            let buttons = "";
            if(currentUser) {
                const isLiked = likedSongIds.includes(song.id);
                const heartIcon = isLiked ? '‚ù§Ô∏è' : 'ü§ç';
                const heartClass = isLiked ? 'btn-heart liked' : 'btn-heart';
                buttons += `<button class="action-btn ${heartClass}" onclick="toggleLike(event, ${song.id})">${heartIcon}</button>`;

                if(song.video_url) buttons += `<button class="action-btn btn-purple" onclick="openVideo(event, '${song.video_url}')">üé•</button>`;
                buttons += `<button class="action-btn btn-green" onclick="openPlaylistModal(${song.id})">‚ûï</button>`;
                
                if(currentUser.role === 'admin') {
                    const songData = JSON.stringify(song).replace(/"/g, '&quot;');
                    buttons += `<button class="action-btn btn-orange" onclick="openEditSong(event, ${songData})">‚úèÔ∏è</button>`;
                    buttons += `<button class="action-btn btn-red" onclick="deleteSongAdmin(event, ${song.id})">üóë</button>`;
                }
            }

            let info = `<strong>${song.title}</strong><br><small>${song.artist}`;
            if(song.genre) info += ` ‚Ä¢ ${song.genre}`;
            if(song.year) info += ` ‚Ä¢ ${song.year}`;
            info += `</small>`;
            li.innerHTML = `<img class="song-img" src="${song.image_url}"><div style="flex:1;">${info}</div>${buttons}`;
            listElement.appendChild(li);
        }

        // --- PLAYER & LYRICS ---
        function playSong(song) {
            if(!song.stream_url) return alert("L·ªói file nh·∫°c");
            document.getElementById('playerBar').style.display='block';
            document.getElementById('nowPlayingText').innerText = "ƒêang ph√°t: " + song.title + " - " + song.artist;
            const aud = document.getElementById('audioPlayer'); 
            aud.src = song.stream_url; 
            aud.play();
            
            // L∆∞u lyrics v√†o bi·∫øn
            currentLyricsContent = song.lyrics ? song.lyrics : "Ch∆∞a c√≥ l·ªùi b√†i h√°t n√†y.";

            if(currentUser) fetch(`${API_URL}/user/history/add`, {method:'POST',headers:{'Content-Type':'application/json','X-User-ID':currentUser.id},body:JSON.stringify({song_id:song.id})});
        }
        function showLyricsModal() {
            document.getElementById('lyricsContent').innerText = currentLyricsContent;
            document.getElementById('lyricsModal').style.display = 'flex';
        }

        // --- VIDEO ---
        function openVideo(e, url) { e.stopPropagation(); document.getElementById('audioPlayer').pause(); document.getElementById('videoModal').style.display='flex'; document.getElementById('videoPlayer').src = url; document.getElementById('videoPlayer').play(); }
        function closeVideo() { document.getElementById('videoModal').style.display='none'; document.getElementById('videoPlayer').pause(); }

        // --- ADMIN EDIT & DELETE ---
        function openEditSong(e, song) {
            e.stopPropagation();
            document.getElementById('editId').value = song.id;
            document.getElementById('editTitle').value = song.title;
            document.getElementById('editArtist').value = song.artist;
            document.getElementById('editGenre').value = song.genre || "";
            document.getElementById('editYear').value = song.year || "";
            document.getElementById('editLyrics').value = song.lyrics || "";
            document.getElementById('editSongModal').style.display = 'flex';
        }
        async function submitEditSong() {
            const id = document.getElementById('editId').value;
            const body = {
                title: document.getElementById('editTitle').value,
                artist: document.getElementById('editArtist').value,
                genre: document.getElementById('editGenre').value,
                year: document.getElementById('editYear').value,
                lyrics: document.getElementById('editLyrics').value
            };
            try {
                const res = await fetch(`${API_URL}/admin/songs/update/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-User-Role': 'admin', 'X-User-ID': currentUser.id },
                    body: JSON.stringify(body)
                });
                if(res.ok) { alert("ƒê√£ l∆∞u!"); closeModal('editSongModal'); loadSongs(); }
            } catch(e) { alert("L·ªói"); }
        }
        async function deleteSongAdmin(e, id) { e.stopPropagation(); if(confirm("X√≥a vƒ©nh vi·ªÖn?")) { await fetch(`${API_URL}/admin/songs/${id}`, { method:'DELETE', headers:{'X-User-Role':'admin', 'X-User-ID':currentUser.id} }); loadSongs(); } }
        
        // --- UPLOAD ---
        async function addSong() {
            const formData = new FormData();
            formData.append('title', document.getElementById('newTitle').value);
            formData.append('artist', document.getElementById('newArtist').value);
            formData.append('genre', document.getElementById('newGenre').value);
            formData.append('year', document.getElementById('newYear').value);
            formData.append('lyrics', document.getElementById('newLyrics').value);
            formData.append('musicFile', document.getElementById('newFile').files[0]);
            formData.append('imageFile', document.getElementById('newImage').files[0]);
            formData.append('videoFile', document.getElementById('newVideo').files[0]);
            try { const res = await fetch(`${API_URL}/admin/songs/add`, { method: 'POST', headers: { 'X-User-Role': 'admin', 'X-User-ID': currentUser.id }, body: formData }); if (res.ok) { alert("Th√†nh c√¥ng!"); loadSongs(); } else alert("L·ªói"); } catch (e) { alert("L·ªói upload!"); }
        }

        // --- OTHER (Playlist, User, History...) ---
        // (Gi·ªØ nguy√™n c√°c h√†m loadPlaylists, viewPl, createPlaylist, delPl, remSong, openPlaylistModal, addToPlaylistNow, loadUsers, deleteUser, toggleLockUser, loadHistory, closeModal nh∆∞ c≈© - Code ƒë√£ qu√° d√†i n√™n t√¥i vi·∫øt t·∫Øt ·ªü ƒë√¢y, trong th·ª±c t·∫ø b·∫°n copy t·ª´ code c≈© c·ªßa t√¥i v√†o l√† ƒë∆∞·ª£c)
        
        async function loadPlaylists() { if(!currentUser) return; const list = document.getElementById('playlist'); const res = await fetch(`${API_URL}/user/playlists`, { headers: { 'X-User-ID': currentUser.id } }); const json = await res.json(); list.innerHTML = ""; if(json.data.length==0) return list.innerHTML="<li style='text-align:center'>Ch∆∞a c√≥ playlist.</li>"; json.data.forEach(pl => { list.innerHTML += `<li class="song-item" style="background:#fff8e1"><div class="playlist-icon">üìÅ</div><div style="flex:1;"><strong>${pl.name}</strong></div><button class="action-btn btn-cyan" onclick="viewPl(${pl.id}, '${pl.name}')">Xem</button><button class="action-btn btn-red" onclick="delPl(${pl.id})">X√≥a</button></li>`; }); }
        async function viewPl(id, name) { const list = document.getElementById('playlist'); const res = await fetch(`${API_URL}/user/playlists/${id}`, { headers: { 'X-User-ID': currentUser.id } }); const json = await res.json(); list.innerHTML = `<li style="border:none"><h3 id="currentPlName">üìÇ ${name}</h3> <button onclick="loadPlaylists()" style="background:#6c757d; color:white; border:none; padding:5px 10px; border-radius:4px;">‚¨Ö Quay l·∫°i</button></li>`; json.data.forEach(song => { const li = document.createElement('li'); li.className='song-item'; li.onclick = (e) => { if(e.target.tagName!=='BUTTON') playSong(song); }; let vidBtn = song.video_url ? `<button class="action-btn btn-purple" onclick="openVideo(event, '${song.video_url}')">üé•</button> ` : ""; li.innerHTML = `<img class="song-img" src="${song.image_url}"><div style="flex:1;"><strong>${song.title}</strong></div>${vidBtn}<button class="action-btn btn-red" onclick="remSong(event, ${id}, ${song.id})">‚ùå</button>`; list.appendChild(li); }); }
        async function createPlaylist() { const name = document.getElementById('newPlName').value; if(!name) return; await fetch(`${API_URL}/user/playlists/create`, { method:'POST', headers:{'Content-Type':'application/json','X-User-ID':currentUser.id}, body:JSON.stringify({name}) }); alert("T·∫°o xong!"); document.getElementById('newPlName').value=""; switchTab('playlists'); }
        async function delPl(id) { if(confirm("X√≥a?")) { await fetch(`${API_URL}/user/playlists/delete/${id}`, {method:'DELETE', headers:{'X-User-ID':currentUser.id}}); loadPlaylists(); } }
        async function remSong(e, plId, sId) { e.stopPropagation(); if(confirm("X√≥a b√†i n√†y?")) { await fetch(`${API_URL}/user/playlists/remove-song`, {method:'DELETE', headers:{'Content-Type':'application/json','X-User-ID':currentUser.id}, body:JSON.stringify({playlist_id:plId, song_id:sId})}); const name = document.getElementById('currentPlName').innerText.replace('üìÇ ',''); viewPl(plId, name); } }
        async function openPlaylistModal(songId) { selectedSongId = songId; document.getElementById('playlistModal').style.display = 'flex'; const list = document.getElementById('modalPlaylistList'); const res = await fetch(`${API_URL}/user/playlists`, { headers: { 'X-User-ID': currentUser.id } }); const json = await res.json(); list.innerHTML = ""; json.data.forEach(pl => { const li = document.createElement('li'); li.className='modal-item'; li.innerHTML = `üìÅ <b>${pl.name}</b>`; li.onclick=()=>addToPlaylistNow(pl.id); list.appendChild(li); }); }
        async function addToPlaylistNow(plId) { const res = await fetch(`${API_URL}/user/playlists/add-song`, {method:'POST', headers:{'Content-Type':'application/json','X-User-ID':currentUser.id}, body:JSON.stringify({playlist_id:plId, song_id:selectedSongId})}); if(res.ok) { alert("‚úÖ ƒê√£ th√™m!"); closeModal('playlistModal'); } else alert("ƒê√£ c√≥ r·ªìi!"); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        async function loadUsers() { if(!currentUser || currentUser.role !== 'admin') return alert("Admin only"); const list = document.getElementById('playlist'); try { const res = await fetch(`${API_URL}/admin/users`, { headers: {'X-User-Role':'admin', 'X-User-ID':currentUser.id} }); const json = await res.json(); list.innerHTML = ""; json.data.forEach(u => { const isLocked = u.is_locked === 1; const statusText = isLocked ? "<b style='color:red'>(Lock)</b>" : "<span style='color:green'>Active</span>"; list.innerHTML += `<li class="song-item" style="cursor:default"><div>üë§ <strong>${u.username}</strong> (${u.role}) <small>${statusText}</small></div>${u.id !== currentUser.id ? `<button class="action-btn btn-orange" onclick="toggleLockUser(${u.id})">Lock/Open</button> <button class="action-btn btn-red" onclick="deleteUser(${u.id})">Del</button>` : ''}</li>`; }); } catch(e) {} }
        async function deleteUser(id) { if(confirm("Del user?")) { await fetch(`${API_URL}/admin/users/${id}`, { method:'DELETE', headers:{'X-User-Role':'admin', 'X-User-ID':currentUser.id} }); loadUsers(); } }
        async function toggleLockUser(id) { const res = await fetch(`${API_URL}/admin/users/lock/${id}`, { method:'PUT', headers:{'X-User-Role':'admin', 'X-User-ID':currentUser.id} }); if(res.ok) loadUsers(); }
        async function loadHistory() { const list = document.getElementById('playlist'); const res = await fetch(`${API_URL}/user/history`, { headers: { 'X-User-ID': currentUser.id } }); const json = await res.json(); list.innerHTML = ""; json.data.forEach(i => list.innerHTML+=`<li class="song-item"><div><strong>${i.title}</strong><br><small>${new Date(i.played_at).toLocaleString()}</small></div></li>`); }
    </script>
</body>
</html>