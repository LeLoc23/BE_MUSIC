<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music App Pro</title>
    <style>
        /* CSS CH√çNH */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        .sidebar { width: 280px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 20px; }
        .main-content { flex: 1; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; flex-direction: column; overflow: hidden; }
        
        /* Auth & Inputs */
        .auth-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .auth-tab { flex: 1; padding: 8px; text-align: center; background: #eee; cursor: pointer; border-radius: 5px; font-size: 13px; }
        .auth-tab.active { background: #007bff; color: white; font-weight: bold; }
        input { padding: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px; cursor: pointer; border: none; border-radius: 8px; font-weight: bold; width: 100%; color: white; background: #007bff; }
        button:hover { background: #0056b3; }

        /* Tabs Ch√≠nh */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { background: #e9ecef; color: #495057; flex: 1; padding: 10px; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; }
        .tab-btn.active { background: #007bff; color: white; }

        /* Search Box */
        .search-container { display: flex; gap: 10px; margin-bottom: 15px; display: none; }
        .search-container input { margin-bottom: 0; }
        .search-container button { width: auto; padding: 0 20px; background: #17a2b8; }

        /* Danh s√°ch */
        .song-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .song-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f1f1f1; border-radius: 8px; cursor: pointer; }
        .song-item:hover { background: #f8f9fa; }
        .song-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; margin-right: 15px; background: #ddd; }
        .playlist-icon { width: 50px; height: 50px; border-radius: 8px; background: #ffc107; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; color: white; }
        
        /* N√∫t Action nh·ªè */
        .action-btn { width: auto; padding: 5px 10px; font-size: 12px; margin-left: 5px; border-radius: 4px; border:none; color:white; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-cyan { background: #17a2b8; }
        .btn-orange { background: #fd7e14; }
        .btn-purple { background: #6f42c1; }

        /* Player */
        .player-bar { margin-top: 20px; padding: 15px; background: #212529; color: white; border-radius: 12px; text-align: center; display: none; }
        audio { width: 100%; margin-top: 10px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: white; padding: 20px; border-radius: 12px; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { font-weight: bold; font-size: 16px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
        .modal-item { padding: 10px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .modal-item:hover { background: #f0f8ff; color: #007bff; }
        .close-btn { background: #6c757d; margin-top: 15px; }
        
        /* Video Modal */
        .video-box { width: 800px; background: #000; position: relative; }
        .video-player { width: 100%; height: 450px; }
        .close-video-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.3); color: white; width: 30px; height: 30px; border-radius: 50%; font-size: 20px; line-height: 30px; padding: 0; }
        .close-video-btn:hover { background: red; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div id="authSection">
            <h3 style="text-align:center; margin-top:0;">üîê T√†i kho·∫£n</h3>
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showAuth('login')" id="tabLogin">ƒêƒÉng Nh·∫≠p</div>
                <div class="auth-tab" onclick="showAuth('register')" id="tabReg">ƒêƒÉng K√Ω</div>
            </div>
            
            <div id="loginForm">
                <input type="text" id="loginUser" placeholder="User (VD: admin)">
                <input type="password" id="loginPass" placeholder="Pass">
                <button onclick="doLogin()">ƒêƒÉng Nh·∫≠p</button>
            </div>
            <div id="regForm" style="display:none;">
                <input type="text" id="regUser" placeholder="User m·ªõi">
                <input type="password" id="regPass" placeholder="Pass m·ªõi">
                <button onclick="doRegister()" class="btn-green">ƒêƒÉng K√Ω</button>
            </div>
            <p id="authMsg" style="color:red; text-align:center; font-size:13px;"></p>
        </div>

        <div id="userSection" style="display:none;">
            <h3 style="margin-top:0;">üëã Hi, <span id="displayUser"></span></h3>
            <p style="font-size:13px; color:#666;">Role: <span id="displayRole" style="font-weight:bold;"></span></p>
            
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <h4>üìÅ Playlist</h4>
                <input type="text" id="newPlName" placeholder="T√™n Playlist...">
                <button onclick="createPlaylist()" style="background:#6c757d;">T·∫°o M·ªõi</button>
            </div>

            <div id="adminPanel" style="display:none; margin-top:20px; background:#fff3cd; padding:10px; border-radius:8px;">
                <h4 style="margin:0 0 10px 0;">üõ† Th√™m Nh·∫°c (Admin)</h4>
                
                <label style="font-size:11px;">T√™n b√†i:</label>
                <input type="text" id="newTitle" placeholder="V√≠ d·ª•: L·∫°c Tr√¥i">
                
                <label style="font-size:11px;">Ca sƒ©:</label>
                <input type="text" id="newArtist" placeholder="V√≠ d·ª•: S∆°n T√πng">
                
                <label style="font-size:11px;">File Nh·∫°c (.mp3):</label>
                <input type="file" id="newFile" accept="audio/*">
                
                <label style="font-size:11px;">·∫¢nh B√¨a (.jpg/png):</label>
                <input type="file" id="newImage" accept="image/*">
                
                <label style="font-size:11px;">Video MV (.mp4) - T√πy ch·ªçn:</label>
                <input type="file" id="newVideo" accept="video/*">
                
                <button onclick="addSong()">‚òÅÔ∏è Upload & Th√™m</button>
            </div>
            <button onclick="doLogout()" class="btn-red" style="margin-top:20px;">ƒêƒÉng Xu·∫•t</button>
        </div>
    </div>

    <div class="main-content">
        <div class="tabs">
            <button class="tab-btn active" id="btnAll" onclick="switchTab('all')">üéµ Kho Nh·∫°c</button>
            <button class="tab-btn" id="btnPl" onclick="switchTab('playlists')">üìÇ Playlist</button>
            <button class="tab-btn" id="btnHistory" onclick="switchTab('history')">üïí L·ªãch S·ª≠</button>
            <button class="tab-btn" id="btnUsers" style="display:none;" onclick="switchTab('users')">üë• QL User</button>
        </div>

        <div id="searchBox" class="search-container">
            <input type="text" id="searchInput" placeholder="üîç T√¨m t√™n b√†i h√°t ho·∫∑c ca sƒ©..." onkeypress="handleEnter(event)">
            <button onclick="searchSong()">T√¨m</button>
        </div>

        <ul class="song-list" id="playlist">
            <li style="text-align:center; padding:20px;">Vui l√≤ng ƒëƒÉng nh·∫≠p...</li>
        </ul>

        <div class="player-bar" id="playerBar">
            <div id="nowPlayingText">S·∫µn s√†ng</div>
            <audio id="audioPlayer" controls></audio>
        </div>
    </div>

    <div class="modal-overlay" id="playlistModal">
        <div class="modal-box">
            <div class="modal-header">Ch·ªçn Playlist</div>
            <ul class="modal-list" id="modalPlaylistList"><li>ƒêang t·∫£i...</li></ul>
            <button class="close-btn" onclick="closeModal('playlistModal')">ƒê√≥ng</button>
        </div>
    </div>

    <div class="modal-overlay" id="videoModal">
        <div class="modal-box video-box">
            <button class="close-video-btn" onclick="closeVideo()">√ó</button>
            <video id="videoPlayer" class="video-player" controls></video>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:3000/api";
        let currentUser = null;
        let selectedSongId = null;

        // --- AUTH ---
        function showAuth(t) {
            document.getElementById('loginForm').style.display = t=='login'?'block':'none';
            document.getElementById('regForm').style.display = t=='register'?'block':'none';
            document.getElementById('tabLogin').className = t=='login'?'auth-tab active':'auth-tab';
            document.getElementById('tabReg').className = t=='register'?'auth-tab active':'auth-tab';
        }
        async function doLogin() {
            const u=document.getElementById('loginUser').value, p=document.getElementById('loginPass').value;
            if(!u||!p) return;
            try {
                const res = await fetch(`${API_URL}/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
                const json = await res.json();
                if(res.ok) {
                    currentUser = json.user;
                    updateUI(true);
                    switchTab('all');
                } else document.getElementById('authMsg').innerText = json.error;
            } catch(e){ alert("L·ªói k·∫øt n·ªëi"); }
        }
        async function doRegister() {
            const u=document.getElementById('regUser').value, p=document.getElementById('regPass').value;
            if(!u||!p) return;
            try {
                const res = await fetch(`${API_URL}/register`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:u, password:p}) });
                const json = await res.json();
                if(res.ok) { alert("ƒêƒÉng k√Ω th√†nh c√¥ng!"); showAuth('login'); }
                else document.getElementById('authMsg').innerText = json.error;
            } catch(e){ alert("L·ªói k·∫øt n·ªëi"); }
        }
        function doLogout() { currentUser=null; updateUI(false); location.reload(); }
        function updateUI(isLogin) {
            document.getElementById('authSection').style.display = isLogin?'none':'block';
            document.getElementById('userSection').style.display = isLogin?'block':'none';
            if(isLogin) {
                document.getElementById('displayUser').innerText = currentUser.username;
                document.getElementById('displayRole').innerText = currentUser.role;
                const isAdmin = currentUser.role==='admin';
                document.getElementById('adminPanel').style.display = isAdmin?'block':'none';
                document.getElementById('btnUsers').style.display = isAdmin?'block':'none';
            }
        }

        // --- TABS & SEARCH ---
        function switchTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const searchBox = document.getElementById('searchBox');
            searchBox.style.display = 'none'; // M·∫∑c ƒë·ªãnh ·∫©n t√¨m ki·∫øm

            if(type=='all') {
                document.getElementById('btnAll').classList.add('active');
                searchBox.style.display = 'flex'; // Ch·ªâ hi·ªán t√¨m ki·∫øm ·ªü tab Nh·∫°c
                loadSongs(); 
            }
            else if(type=='playlists') {
                document.getElementById('btnPl').classList.add('active');
                loadPlaylists(); 
            }
            else if(type=='history') {
                document.getElementById('btnHistory').classList.add('active');
                loadHistory();
            }
            else if(type=='users') {
                document.getElementById('btnUsers').classList.add('active');
                loadUsers();
            }
        }

        function searchSong() {
            const keyword = document.getElementById('searchInput').value;
            loadSongs(keyword);
        }
        function handleEnter(e) { if(e.key==='Enter') searchSong(); }

        // --- 1. NH·∫†C & T√åM KI·∫æM ---
        async function loadSongs(query="") {
            const list = document.getElementById('playlist');
            list.innerHTML = "<li>ƒêang t·∫£i...</li>";
            
            // X·ª≠ l√Ω URL t√¨m ki·∫øm
            let url = `${API_URL}/songs`;
            if(query) url += `?q=${encodeURIComponent(query)}`;

            const res = await fetch(url);
            const json = await res.json();
            list.innerHTML = "";
            
            if (json.data.length === 0) {
                list.innerHTML = `<li style="text-align:center; padding:20px;">Kh√¥ng t√¨m th·∫•y b√†i h√°t n√†o.</li>`;
                return;
            }

            json.data.forEach(song => {
                const li = document.createElement('li'); li.className='song-item';
                li.onclick = (e) => { if(e.target.tagName!=='BUTTON') playSong(song.stream_url, song.title, song.id); };
                
                let buttons = "";
                if(currentUser) {
                    if(song.video_url) buttons += `<button class="action-btn btn-purple" onclick="openVideo(event, '${song.video_url}')">üé• MV</button>`;
                    buttons += `<button class="action-btn btn-green" onclick="openPlaylistModal(${song.id})">‚ûï PL</button>`;
                    if(currentUser.role === 'admin') {
                        buttons += `<button class="action-btn btn-red" onclick="deleteSongAdmin(event, ${song.id})">üóë X√≥a</button>`;
                    }
                }

                li.innerHTML = `
                    <img class="song-img" src="${song.image_url}" onerror="this.src='https://via.placeholder.com/50'">
                    <div style="flex:1;"><strong>${song.title}</strong><br><small>${song.artist}</small></div>
                    ${buttons}
                `;
                list.appendChild(li);
            });
        }

        // --- VIDEO ---
        function openVideo(e, url) {
            e.stopPropagation(); document.getElementById('audioPlayer').pause();
            document.getElementById('videoModal').style.display='flex';
            document.getElementById('videoPlayer').src = url;
            document.getElementById('videoPlayer').play();
        }
        function closeVideo() {
            document.getElementById('videoModal').style.display='none';
            document.getElementById('videoPlayer').pause();
        }

        // --- 2. ADMIN USER ---
        async function loadUsers() {
            if(!currentUser || currentUser.role !== 'admin') return alert("C·∫ßn quy·ªÅn Admin!");
            const list = document.getElementById('playlist');
            list.innerHTML = "<li>ƒêang t·∫£i danh s√°ch User...</li>";
            try {
                const res = await fetch(`${API_URL}/admin/users`, { headers: {'X-User-Role':'admin', 'X-User-ID':currentUser.id} });
                const json = await res.json();
                list.innerHTML = "";
                json.data.forEach(u => {
                    const isLocked = u.is_locked === 1;
                    const statusText = isLocked ? "<b style='color:red'>(B·ªã Kh√≥a)</b>" : "<span style='color:green'>Ho·∫°t ƒë·ªông</span>";
                    const lockBtnText = isLocked ? "üîì M·ªü" : "üîí Kh√≥a";
                    const lockBtnColor = isLocked ? "btn-green" : "btn-orange";
                    const li = document.createElement('li'); li.className='song-item'; li.style.cursor = 'default';
                    li.innerHTML = `
                        <div style="font-size:20px; margin-right:15px;">üë§</div>
                        <div style="flex:1;"><strong>${u.username}</strong> (${u.role})<br><small>${statusText}</small></div>
                        ${u.id !== currentUser.id ? `<button class="action-btn ${lockBtnColor}" onclick="toggleLockUser(${u.id})">${lockBtnText}</button> <button class="action-btn btn-red" onclick="deleteUser(${u.id})">üóë X√≥a</button>` : '<small>T√¥i</small>'}
                    `;
                    list.appendChild(li);
                });
            } catch(e) { console.error(e); }
        }
        async function deleteSongAdmin(e, id) {
            e.stopPropagation();
            if(!confirm("X√≥a b√†i h√°t n√†y vƒ©nh vi·ªÖn?")) return;
            const res = await fetch(`${API_URL}/admin/songs/${id}`, { method:'DELETE', headers:{'X-User-Role':'admin', 'X-User-ID':currentUser.id} });
            if(res.ok) { alert("ƒê√£ x√≥a nh·∫°c!"); loadSongs(); } else alert("L·ªói x√≥a");
        }
        async function deleteUser(id) {
            if(!confirm("X√≥a user n√†y?")) return;
            const res = await fetch(`${API_URL}/admin/users/${id}`, { method:'DELETE', headers:{'X-User-Role':'admin', 'X-User-ID':currentUser.id} });
            if(res.ok) { alert("ƒê√£ x√≥a user!"); loadUsers(); } else alert("L·ªói x√≥a");
        }
        async function toggleLockUser(id) {
            const res = await fetch(`${API_URL}/admin/users/lock/${id}`, { method:'PUT', headers:{'X-User-Role':'admin', 'X-User-ID':currentUser.id} });
            if(res.ok) { 
                const json = await res.json();
                alert(json.message); 
                loadUsers(); 
            } else alert("L·ªói t√°c v·ª•");
        }

        // --- PLAYLIST ---
        async function loadPlaylists() {
            if(!currentUser) return;
            const list = document.getElementById('playlist');
            const res = await fetch(`${API_URL}/user/playlists`, { headers: { 'X-User-ID': currentUser.id } });
            const json = await res.json();
            list.innerHTML = "";
            if(json.data.length==0) return list.innerHTML="<li style='text-align:center'>Ch∆∞a c√≥ playlist.</li>";
            json.data.forEach(pl => {
                list.innerHTML += `<li class="song-item" style="background:#fff8e1"><div class="playlist-icon">üìÅ</div><div style="flex:1;"><strong>${pl.name}</strong></div><button class="action-btn btn-cyan" onclick="viewPl(${pl.id}, '${pl.name}')">Xem</button><button class="action-btn btn-red" onclick="delPl(${pl.id})">X√≥a</button></li>`;
            });
        }
        async function viewPl(id, name) {
            const list = document.getElementById('playlist');
            const res = await fetch(`${API_URL}/user/playlists/${id}`, { headers: { 'X-User-ID': currentUser.id } });
            const json = await res.json();
            list.innerHTML = `<li style="border:none"><h3 id="currentPlName">üìÇ ${name}</h3> <button onclick="loadPlaylists()" style="background:#6c757d; color:white; border:none; padding:5px 10px; border-radius:4px;">‚¨Ö Quay l·∫°i</button></li>`;
            if(json.data.length==0) list.innerHTML+="<li style='text-align:center'>Tr·ªëng</li>";
            json.data.forEach(song => {
                const li = document.createElement('li'); li.className='song-item';
                li.onclick = (e) => { if(e.target.tagName!=='BUTTON') playSong(song.stream_url, song.title, song.id); };
                li.innerHTML = `<img class="song-img" src="${song.image_url}" onerror="this.src='https://via.placeholder.com/50'"><div style="flex:1;"><strong>${song.title}</strong></div><button class="action-btn btn-red" onclick="remSong(event, ${id}, ${song.id})">‚ùå</button>`;
                list.appendChild(li);
            });
        }
        async function createPlaylist() {
            const name = document.getElementById('newPlName').value;
            if(!name) return;
            await fetch(`${API_URL}/user/playlists/create`, { method:'POST', headers:{'Content-Type':'application/json','X-User-ID':currentUser.id}, body:JSON.stringify({name}) });
            alert("T·∫°o xong!"); document.getElementById('newPlName').value=""; switchTab('playlists');
        }
        async function delPl(id) { if(confirm("X√≥a?")) { await fetch(`${API_URL}/user/playlists/delete/${id}`, {method:'DELETE', headers:{'X-User-ID':currentUser.id}}); loadPlaylists(); } }
        async function remSong(e, plId, sId) { e.stopPropagation(); if(confirm("X√≥a b√†i n√†y?")) { await fetch(`${API_URL}/user/playlists/remove-song`, {method:'DELETE', headers:{'Content-Type':'application/json','X-User-ID':currentUser.id}, body:JSON.stringify({playlist_id:plId, song_id:sId})}); const name = document.getElementById('currentPlName').innerText.replace('üìÇ ',''); viewPl(plId, name); } }
        
        async function openPlaylistModal(songId) {
            selectedSongId = songId;
            document.getElementById('playlistModal').style.display = 'flex';
            const list = document.getElementById('modalPlaylistList');
            const res = await fetch(`${API_URL}/user/playlists`, { headers: { 'X-User-ID': currentUser.id } });
            const json = await res.json();
            list.innerHTML = "";
            if(json.data.length===0) list.innerHTML="<li class='modal-item'>B·∫°n ch∆∞a c√≥ playlist n√†o.</li>";
            json.data.forEach(pl => {
                const li = document.createElement('li'); li.className='modal-item';
                li.innerHTML = `üìÅ <b>${pl.name}</b>`; li.onclick=()=>addToPlaylistNow(pl.id);
                list.appendChild(li);
            });
        }
        async function addToPlaylistNow(plId) {
            const res = await fetch(`${API_URL}/user/playlists/add-song`, {method:'POST', headers:{'Content-Type':'application/json','X-User-ID':currentUser.id}, body:JSON.stringify({playlist_id:plId, song_id:selectedSongId})});
            if(res.ok) { alert("‚úÖ ƒê√£ th√™m!"); closeModal('playlistModal'); } else alert("ƒê√£ c√≥ r·ªìi!");
        }
        function closeModal(id) { document.getElementById(id).style.display='none'; }

        // --- OTHER ---
        async function loadHistory() {
            const list = document.getElementById('playlist');
            const res = await fetch(`${API_URL}/user/history`, { headers: { 'X-User-ID': currentUser.id } });
            const json = await res.json();
            list.innerHTML = "";
            json.data.forEach(i => list.innerHTML+=`<li class="song-item"><div><strong>${i.title}</strong><br><small>${new Date(i.played_at).toLocaleString()}</small></div></li>`);
        }
        function playSong(url, title, id) {
            if(!url) return alert("L·ªói file nh·∫°c");
            document.getElementById('playerBar').style.display='block';
            document.getElementById('nowPlayingText').innerText = "ƒêang ph√°t: "+title;
            const aud = document.getElementById('audioPlayer'); aud.src=url; aud.play();
            if(currentUser) fetch(`${API_URL}/user/history/add`, {method:'POST',headers:{'Content-Type':'application/json','X-User-ID':currentUser.id},body:JSON.stringify({song_id:id})});
        }

        async function addSong() {
            const title = document.getElementById('newTitle').value;
            const artist = document.getElementById('newArtist').value;
            const musicFile = document.getElementById('newFile').files[0];
            const imageFile = document.getElementById('newImage').files[0];
            const videoFile = document.getElementById('newVideo').files[0];

            if (!title || !artist || !musicFile) return alert("Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc!");

            const formData = new FormData();
            formData.append('title', title);
            formData.append('artist', artist);
            formData.append('musicFile', musicFile);
            if(imageFile) formData.append('imageFile', imageFile);
            if(videoFile) formData.append('videoFile', videoFile);

            try {
                const res = await fetch(`${API_URL}/admin/songs/add`, {
                    method: 'POST',
                    headers: { 'X-User-Role': 'admin', 'X-User-ID': currentUser.id },
                    body: formData
                });
                const json = await res.json();
                if (res.ok) { 
                    alert("‚úÖ Upload th√†nh c√¥ng!"); 
                    // Clear form
                    document.getElementById('newTitle').value="";
                    document.getElementById('newArtist').value="";
                    document.getElementById('newFile').value="";
                    document.getElementById('newImage').value="";
                    document.getElementById('newVideo').value="";
                    loadSongs();
                }
                else alert("L·ªói: " + json.error);
            } catch (e) { alert("L·ªói upload!"); }
        }
    </script>
</body>
</html>